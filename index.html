<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Reclassifica√ß√£o (Rateio)</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #F7F7F7;
            --text-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); }
        header { background-color: var(--primary-color); color: white; padding: 20px 0; text-align: center; margin-bottom: 30px; }
        .container { max-width: 1200px; margin: auto; padding: 30px; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h2 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 25px; font-size: 1.5em; }
        .section-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #555; }
        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s; font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        textarea { resize: vertical; min-height: 100px; }
        
        /* ESTILOS DA SE√á√ÉO DE RATEIO (EM LINHA) */
        .rateio-header { display: flex; font-weight: 600; margin-bottom: 10px; padding: 0 10px; color: var(--primary-color); font-size: 0.9em;}
        .rateio-header div { flex-grow: 1; margin-right: 10px; }
        .rateio-header .header-center, .rateio-header .header-valor { flex: 0 0 100px; } /* Ajuste de largura para inputs */
        .rateio-header .header-remover { flex: 0 0 30px; } 

        .rateio-item { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px; align-items: center; }
        .rateio-item select, .rateio-item input { flex-grow: 1; }
        .rateio-item .select-container { flex-grow: 1; }
        
        .rateio-item .input-center { flex: 0 0 100px; }
        .rateio-item .input-valor { flex: 0 0 100px; }

        .btn-add-line { background-color: #5cb85c; margin-top: 15px; }
        .btn-add-line:hover { background-color: #4cae4c; }
        .btn-remove-line { background-color: #dc3545; color: white; padding: 8px 10px; border: none; border-radius: 4px; cursor: pointer; flex: 0 0 30px;}
        .btn-remove-line:hover { background-color: #c9303d; }

        button.btn-submit { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s; width: 100%; margin-top: 25px;}
        button.btn-submit:disabled { background-color: #a4c4db; cursor: not-allowed; }
        button.btn-submit:hover:not(:disabled) { background-color: #004580; }

        .message-box { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: 600; display: none; }
        .success { background-color: #d4edda; color: var(--success-color); border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: var(--error-color); border: 1px solid #f5c6cb; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2em; color: var(--primary-color); display: none; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Carregando Op√ß√µes de Conta...</div>
    <header>
        <h1>Formul√°rio de Reclassifica√ß√£o de Centro/Conta</h1>
    </header>

    <div class="container">
        <form id="submission-form" enctype="multipart/form-data">
            
            <h2>1. Dados do Solicitante e Documento</h2>
            <div class="section-grid">
                <div class="input-group">
                    <label for="solicitante">Solicitante:</label>
                    <input type="text" id="solicitante" name="solicitante" required>
                </div>
                <div class="input-group">
                    <label for="parceiro">Nome do Parceiro:</label>
                    <input type="text" id="parceiro" name="parceiro" required>
                </div>
                <div class="input-group">
                    <label for="docNumero">N¬∫ do Documento:</label>
                    <input type="text" id="docNumero" name="docNumero" required>
                </div>
                <div class="input-group">
                    <label for="valorTotal">Valor Total do Documento (Cheio):</label>
                    <input type="number" step="0.01" id="valorTotal" name="valorTotal" required>
                </div>
                <div class="input-group">
                    <label for="competencia">Compet√™ncia:</label>
                    <select id="competencia" name="competencia" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="areaDestino">√Årea Destino:</label>
                    <select id="areaDestino" name="areaDestino" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
            </div>

            <h2>2. Detalhamento e Rateio da Conta</h2>
            
            <div class="rateio-header">
                <div style="flex-grow: 2;">N√≠vel 1</div>
                <div style="flex-grow: 2;">N√≠vel 2</div>
                <div style="flex-grow: 2;">N√≠vel 3</div>
                <div style="flex-grow: 2;">N√≠vel 4</div>
                <div style="flex-grow: 2;">N√≠vel 5</div>
                <div class="header-center">Centro</div>
                <div class="header-valor">Valor Rateado</div>
                <div class="header-remover"></div>
            </div>
            
            <div id="rateio-container">
                </div>
            
            <button type="button" class="btn-add-line" id="add-rateio-line">Fazer Rateio (Adicionar Linha)</button>
            
            <input type="hidden" id="numRateios" name="numRateios" value="0">


            <h2>3. Justificativa</h2>
            <div class="input-group">
                <label for="justificativa">Justificativa Detalhada da Reclassifica√ß√£o:</label>
                <textarea id="justificativa" name="justificativa" rows="4" required></textarea>
            </div>
            
            <button type="submit" class="btn-submit">Enviar Pedido de Reclassifica√ß√£o</button>
            <div id="form-message" class="message-box"></div>
        </form>
    </div>

    <script>
        // =======================================================================
        // üõë COLE O SEU URL DA WEB APP DO APPS SCRIPT AQUI
        // =======================================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8H2P6Mur5XroK3kvtuXVppW4-utOEZ4eXm080vLonQwrPey2YhAXBK_50hZl1gqLL/exec'; 
        
        // Vari√°veis de Controle
        const submissionForm = document.getElementById("submission-form");
        const formMessage = document.getElementById("form-message");
        const loadingOverlay = document.getElementById("loading-overlay");
        const rateioContainer = document.getElementById('rateio-container');
        let allOptionsData = []; // Matriz completa da aba 'Opcoes'

        // Mapeamento dos Seletores Fixos
        const fixedSelects = {
            'Compet√™ncia': document.getElementById('competencia'),
            '√Årea Destino': document.getElementById('areaDestino') 
        };

        // =======================================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =======================================================================

        function showMessage(type, message) {
            formMessage.style.display = 'block';
            formMessage.className = `message-box ${type}`;
            formMessage.innerHTML = message;
        }

        function populateSelect(selectElement, options, initialText = 'Selecione') {
            selectElement.innerHTML = `<option value="" disabled selected>${initialText}</option>`;
            const uniqueOptions = [...new Set(options.filter(Boolean))]; 
            
            uniqueOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.disabled = (uniqueOptions.length === 0);
        }

        // =======================================================================
        // L√ìGICA DE CASCATA E RATEIO
        // =======================================================================

        function createRateioLine() {
            const lineId = Date.now(); // ID √∫nico para a linha
            const div = document.createElement('div');
            div.className = 'rateio-item';
            div.id = `line-${lineId}`;
            
            let html = '';
            
            // Cria os 5 seletores em cascata
            for (let i = 1; i <= 5; i++) {
                html += `
                    <div class="select-container">
                        <select 
                            name="nivel${i}" 
                            id="nivel${i}-${lineId}" 
                            required 
                            disabled 
                            data-level="${i}" 
                            data-line-id="${lineId}"
                        >
                            <option value="">Carregando N√≠veis...</option>
                        </select>
                    </div>
                `;
            }

            // Campos de Input Manual (Centro e Valor)
            html += `
                <div class="input-center">
                    <input type="text" name="centro" placeholder="Centro" required>
                </div>
                <div class="input-valor">
                    <input type="number" step="0.01" name="valorRateio" placeholder="Valor" required>
                </div>
            `;

            // Bot√£o de Remover
            html += `
                <button type="button" class="btn-remove-line" onclick="removeRateioLine('${div.id}')">X</button>
            `;

            div.innerHTML = html;
            rateioContainer.appendChild(div);

            // 1. Inicializa o N√≠vel 1 desta nova linha
            const nivel1Select = document.getElementById(`nivel1-${lineId}`);
            const nivel1Options = allOptionsData.map(row => row[0]);
            populateSelect(nivel1Select, nivel1Options, 'N√≠vel 1');
            nivel1Select.disabled = false;

            // 2. Adiciona os Event Listeners de CASCATA para esta nova linha
            for (let i = 1; i <= 4; i++) {
                const currentSelect = document.getElementById(`nivel${i}-${lineId}`);
                currentSelect.addEventListener('change', () => filterAndPopulateLine(i, lineId));
            }
        }

        // Remove a linha do DOM
        function removeRateioLine(lineId) {
            const line = document.getElementById(lineId);
            if (line) {
                rateioContainer.removeChild(line);
            }
        }

       // Remova o 'required' de todos os <select name="nivel..."> no HTML!
// ...

// ... (Resto do seu c√≥digo JS)

function filterAndPopulateLine(currentLevel, lineId) {
    const currentSelect = document.getElementById(`nivel${currentLevel}-${lineId}`);
    const nextLevel = currentLevel + 1;
    const selectedValue = currentSelect.value;
    
    // --- 1. Limpa e desativa todos os n√≠veis seguintes ---
    for (let i = nextLevel; i <= 5; i++) {
        const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
        nextSelect.innerHTML = `<option value="" disabled selected>N√≠vel ${i}</option>`;
        nextSelect.disabled = true;
    }

    if (!selectedValue) {
        // Se o usu√°rio desmarcar o n√≠vel atual, ele n√£o precisa ser um filtro para o pr√≥ximo
        // Mas se ele desmarcou o N√≠vel 1, n√£o h√° como filtrar mais nada.
        return; 
    }

    // --- 2. Coleta a Cadeia de Filtros ---
    // Cria um array de valores selecionados at√© o n√≠vel anterior ao que estamos populando.
    const selectedChain = [];
    for (let i = 1; i <= currentLevel; i++) {
        const select = document.getElementById(`nivel${i}-${lineId}`);
        // Se o valor estiver vazio, interrompe a cadeia de filtro, pois n√£o h√° como ir adiante
        if (!select.value) break; 
        selectedChain.push(select.value);
    }
    
    // O pr√≥ximo n√≠vel a ser populado.
    const nextSelect = document.getElementById(`nivel${nextLevel}-${lineId}`);
    if (!nextSelect) return; 

    // --- 3. Aplica o Filtro M√∫ltiplo ---
    let filteredOptions = allOptionsData;
    
    // Filtra a matriz completa (allOptionsData) usando TODOS os valores da selectedChain
    for (let i = 0; i < selectedChain.length; i++) {
        const filterValue = selectedChain[i];
        const filterIndex = i; // Coluna na matriz (0 para N√≠vel 1, 1 para N√≠vel 2, etc.)

        filteredOptions = filteredOptions.filter(row => row[filterIndex] === filterValue);
    }
    
    // Pega as op√ß√µes para o PR√ìXIMO N√çVEL (nextLevel - 1 √© o √≠ndice da coluna)
    const nextOptions = filteredOptions.map(row => row[nextLevel - 1]);
    
    populateSelect(nextSelect, nextOptions, `N√≠vel ${nextLevel}`);
    nextSelect.disabled = false;
}
        // =======================================================================
        // L√ìGICA DE CARREGAMENTO INICIAL
        // =======================================================================

        async function loadOptionsAndFixedLists() {
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_options`);
                const data = await response.json();

                if (data.result === 'success') {
                    // Os N√≠veis 1 a 5 est√£o nas colunas 0 a 4 da matriz
                    allOptionsData = data.cascadingOptions; 

                    // 1. Carrega as listas fixas
                    for (const header in fixedSelects) {
                        const options = data.fixedLists[header] || [];
                        if (fixedSelects[header]) {
                            populateSelect(fixedSelects[header], options, `Selecione a ${header}`);
                            fixedSelects[header].disabled = false;
                        }
                    }

                    // 2. Cria a primeira linha de rateio
                    if (rateioContainer.children.length === 0) {
                        createRateioLine();
                    }
                    
                } else {
                    showMessage('error', `Erro ao carregar op√ß√µes: ${data.error || 'Resposta inv√°lida do servidor.'}`);
                }
            } catch (error) {
                console.error('Erro ao carregar op√ß√µes:', error);
                showMessage('error', 'Falha na conex√£o com o Apps Script. Verifique a URL e o Deploy.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // =======================================================================
        // L√ìGICA DE ENVIO DO FORMUL√ÅRIO (doPost)
        // =======================================================================

        submissionForm.addEventListener("submit", async function(event) {
            event.preventDefault(); 
            const submitButton = submissionForm.querySelector('button.btn-submit');

            // ‚ö†Ô∏è Valida√ß√£o de Soma (Opcional, mas Altamente Recomendada)
            const valorTotalDoc = parseFloat(document.getElementById('valorTotal').value) || 0;
            const rateioInputs = document.querySelectorAll('input[name="valorRateio"]');
            let somaRateio = 0;
            rateioInputs.forEach(input => {
                somaRateio += parseFloat(input.value) || 0;
            });

            if (Math.abs(valorTotalDoc - somaRateio) > 0.01) {
                showMessage('error', `Erro de Rateio: O Valor Total do Documento (${valorTotalDoc.toFixed(2)}) n√£o corresponde √† soma dos rateios (${somaRateio.toFixed(2)}).`);
                return;
            }
            // Fim da Valida√ß√£o de Soma

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando Pedido...';
            showMessage('loading', 'Processando sua solicita√ß√£o...');
            
            const data = new FormData(submissionForm);
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', 
                    body: data 
                });

                if (!response.ok) { throw new Error('Erro de rede ou servidor Apps Script.'); }
                const responseData = await response.json();

                if (responseData && responseData.result === "success") {
                    showMessage('success', `Sucesso! Seu pedido foi registrado. ID do Documento: #${responseData.id}.`);
                    submissionForm.reset(); 
                    rateioContainer.innerHTML = ''; // Limpa as linhas de rateio
                    loadOptionsAndFixedLists(); // Reinicia
                } else {
                    throw new Error("Resposta inesperada do servidor Apps Script. Verifique o console.");
                }

            } catch (error) {
                console.error('Erro:', error);
                showMessage('error', "Ops! Houve um erro no envio. Verifique a URL do Apps Script e o console do navegador.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Pedido de Reclassifica√ß√£o';
            }
        });

        // =======================================================================
        // INICIALIZA√á√ÉO E EVENTOS
        // =======================================================================
        document.getElementById('add-rateio-line').addEventListener('click', createRateioLine);
        document.addEventListener('DOMContentLoaded', loadOptionsAndFixedLists);
    </script>
</body>
</html>
