<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Reclassificação (Rateio)</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #F7F7F7;
            --text-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); }
        header { background-color: var(--primary-color); color: white; padding: 20px 0; text-align: center; margin-bottom: 30px; }
        .container { max-width: 1200px; margin: auto; padding: 30px; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h2 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 25px; font-size: 1.5em; }
        /* GRID MUDOU PARA 4 COLUNAS POR CAUSA DO NOVO CAMPO EMAIL */
        .section-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; } 
        /* NOVO: Ajuste para acomodar Centro e Nível 1 no cabeçalho. Mantive 4 colunas */
        .header-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 25px; } 

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #555; }
        input[type="text"], input[type="number"], input[type="email"], select, textarea, input[type="file"] { 
            width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s; font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        textarea { resize: vertical; min-height: 100px; }
        
        /* ESTILOS DA SEÇÃO DE RATEIO (EM LINHA) */
        /* ATENÇÃO: CSS AJUSTADO PARA 4 NÍVEIS + VALOR */
        .rateio-header { display: flex; font-weight: 600; margin-bottom: 10px; padding: 0 10px; color: var(--primary-color); font-size: 0.9em;}
        .rateio-header div { flex-grow: 1; margin-right: 10px; }
        .rateio-header .header-valor { flex: 0 0 120px; text-align: right;} 
        .rateio-header .header-remover { flex: 0 0 30px; } 
        /* 4 Níveis ocupam 80% e o valor 20% */
        .rateio-header .header-niveis { flex-grow: 1; }

        .rateio-item { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px; align-items: center; }
        .rateio-item select, .rateio-item input { flex-grow: 1; }
        .rateio-item .select-container { flex-grow: 1; }
        
        .rateio-item .input-valor { flex: 0 0 120px; } /* Ajuste de largura */

        .btn-add-line { background-color: #5cb85c; margin-top: 15px; }
        .btn-add-line:hover { background-color: #4cae4c; }
        .btn-remove-line { background-color: #dc3545; color: white; padding: 8px 10px; border: none; border-radius: 4px; cursor: pointer; flex: 0 0 30px;}
        .btn-remove-line:hover { background-color: #c9303d; }

        button.btn-submit { background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s; width: 100%; margin-top: 25px;}
        button.btn-submit:disabled { background-color: #a4c4db; cursor: not-allowed; }
        button.btn-submit:hover:not(:disabled) { background-color: #004580; }

        .message-box { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: 600; display: none; }
        .success { background-color: #d4edda; color: var(--success-color); border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: var(--error-color); border: 1px solid #f5c6cb; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2em; color: var(--primary-color); display: none; }

        /* NOVO CSS para a seção de busca e rastreamento */
        .search-container {
            max-width: 1200px;
            margin-top: 0; 
            margin-bottom: 30px;
            padding: 30px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); 
        }
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #searchQuery {
            flex-grow: 1;
            padding: 10px;
        }
        #btnSearch {
            background-color: var(--success-color);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #btnSearch:hover {
            background-color: #1e7e34;
        }
        .results-table-container {
            margin-top: 20px;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th, .results-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
            font-size: 0.9em;
        }
        .results-table th {
            background-color: #f1f1f1;
            color: var(--primary-color);
            font-weight: 600;
        }
        .results-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #searchPlaceholder {
            text-align: center;
            color: #888;
            padding: 15px;
        }
        /* FIM NOVO CSS */
        
        /* 🎨 NOVO CSS para STATUS (Cores e Tags) - MANTIDO 🎨 */
        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 700;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .status-pendente { background-color: #ffc107; color: #333; } /* Amarelo */
        .status-em_andamento { background-color: #17a2b8; color: white; } /* Azul Claro/Ciano */
        .status-finalizado { background-color: #28a745; color: white; } /* Verde */
        .status-duvida_enviada { background-color: #fd7e14; color: white; } /* Laranja */
        .status-nao_encontrado { background-color: #6c757d; color: white; } /* Cinza (para qualquer outro status) */
        /* FIM CSS STATUS */
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Carregando...</div>
    <header>
        <h1>Formulário de Reclassificação de Centro/Conta</h1>
    </header>

    <div class="container search-container">
        <h2>4. Rastreamento de Pedidos</h2>
        <div class="search-bar">
            <input type="text" id="searchQuery" placeholder="Pesquisar por ID ou Solicitante..." />
            <button type="button" id="btnSearch">Buscar Pedidos</button>
        </div>
        
        <div id="searchResults" class="results-table-container">
            <p id="searchPlaceholder">Use o campo acima para buscar pedidos pelo ID (ex: 12345) ou pelo nome do solicitante.</p>
        </div>
    </div>
    <div class="container">
        <form id="submission-form" enctype="multipart/form-data"> 
            
            <h2>1. Dados do Solicitante e Documento</h2>
            <div class="header-grid">
                <div class="input-group">
                    <label for="solicitante">Solicitante:</label>
                    <input type="text" id="solicitante" name="solicitante" required>
                </div>
                <div class="input-group">
                    <label for="emailSolicitante">E-mail do Solicitante:</label>
                    <input type="email" id="emailSolicitante" name="emailSolicitante" required>
                </div>
                <div class="input-group">
                    <label for="parceiro">Nome do Parceiro:</label>
                    <input type="text" id="parceiro" name="parceiro" required>
                </div>
                <div class="input-group">
                    <label for="docNumero">Nº do Documento/Histórico:</label>
                    <input type="text" id="docNumero" name="docNumero" required>
                </div>
                <div class="input-group">
                    <label for="valorTotal">Valor Total do Documento (Cheio):</label>
                    <input type="number" step="0.01" id="valorTotal" name="valorTotal" required>
                </div>
                <div class="input-group">
                    <label for="competencia">Competência:</label>
                    <select id="competencia" name="competencia" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="areaDestino">Área Destino:</label>
                    <select id="areaDestino" name="areaDestino" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                                <div class="input-group">
                    <label for="nivel1_header">Nível 1 (Área):</label>
                                        <select id="nivel1_header" name="nivel1_header" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                                <div class="input-group">
                    <label for="centro">Centro de Custo/Receita*:</label>
                    <select id="centro" name="centro" required disabled>
                        <option value="">Selecione a Área primeiro</option>
                    </select>
                </div>

            </div>

            <h2>2. Detalhamento e Rateio da Conta</h2>
            
            <div class="rateio-header">
                                <div style="flex-grow: 2;">Área (N1)</div>
                <div style="flex-grow: 2;">N2</div>
                <div style="flex-grow: 2;">N3</div>
                <div style="flex-grow: 2;">N4</div>
                                <div class="header-valor">Valor Rateado</div>
                <div class="header-remover"></div>
            </div>
            
            <div id="rateio-container">
                            </div>
            
            <button type="button" class="btn-add-line" id="add-rateio-line">Fazer Rateio (Adicionar Linha)</button>
            
            <input type="hidden" id="numRateios" name="numRateios" value="0">


            <h2>3. Descrição e Anexos</h2>
            <div class="input-group">
                <label for="justificativa">Descrição Detalhada da Reclassificação:</label>
                <textarea id="justificativa" name="justificativa" rows="4" required></textarea>
            </div>
            <div class="input-group">
                <label for="fileUpload">Anexar Documentos/Fotos (Opcional):</label>
                <input type="file" id="fileUpload" name="fileUpload" multiple>
            </div>
            
            <button type="submit" class="btn-submit">Enviar Pedido de Reclassificação</button>
            <div id="form-message" class="message-box"></div>
        </form>
    </div>

    <script>
        // =======================================================================
        // 🛑 COLE O SEU URL DA WEB APP DO APPS SCRIPT AQUI
        // =======================================================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8H2P6Mur5XroK3kvtuXVppW4-utOEZ4eXm080vLonQwrPey2YhAXBK_50hZl1gqLL/exec'; 
        
        // Variáveis de Controle
        const submissionForm = document.getElementById("submission-form");
        const formMessage = document.getElementById("form-message");
        const loadingOverlay = document.getElementById("loading-overlay");
        const rateioContainer = document.getElementById('rateio-container');
        let allOptionsData = []; // Matriz completa da aba 'Opcoes'
        let allFixedLists = {}; // Armazena as listas fixas (incluindo o Centro)

        // Mapeamento dos Seletores Fixos (Agora inclui o Nível 1/Área e o Centro)
        const fixedSelects = {
            'Competência': document.getElementById('competencia'),
            'Área Destino': document.getElementById('areaDestino'), 
            'Nível 1 (Header)': document.getElementById('nivel1_header'), // Novo
            'Centro': document.getElementById('centro') // Novo
        };

        // =======================================================================
        // FUNÇÕES UTILITÁRIAS
        // =======================================================================

        function showMessage(type, message) {
            formMessage.style.display = 'block';
            formMessage.className = `message-box ${type}`;
            formMessage.innerHTML = message;
        }

        function populateSelect(selectElement, options, initialText = 'Selecione') {
            selectElement.innerHTML = `<option value="" selected>${initialText}</option>`;
            const uniqueOptions = [...new Set(options.filter(Boolean))].sort(); 
            
            uniqueOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.disabled = (uniqueOptions.length === 0);
        }

        // =======================================================================
        // LÓGICA DE CASCATA E RATEIO (AJUSTADA PARA 4 NÍVEIS E CENTRO NO HEADER)
        // =======================================================================

        function createRateioLine() {
            const lineId = Date.now(); // ID único para a linha
            const div = document.createElement('div');
            div.className = 'rateio-item';
            div.id = `line-${lineId}`;
            
            let html = '';
            
            // Cria os 4 seletores em cascata (N1, N2, N3, N4)
            for (let i = 1; i <= 4; i++) {
                html += `
                    <div class="select-container">
                        <select 
                            name="nivel${i}" 
                            id="nivel${i}-${lineId}" 
                            disabled 
                            data-level="${i}" 
                            data-line-id="${lineId}"
                        >
                            <option value="">Carregando Níveis...</option>
                        </select>
                    </div>
                `;
            }

            // Campo de Input do Valor
            html += `
                <div class="input-valor">
                    <input type="number" step="0.01" name="valorRateio" placeholder="Valor" required>
                </div>
            `;

            // Botão de Remover
            html += `
                <button type="button" class="btn-remove-line" onclick="removeRateioLine('${div.id}')">X</button>
            `;

            div.innerHTML = html;
            rateioContainer.appendChild(div);

            // 1. Inicializa o Nível 1 desta nova linha
            const nivel1Select = document.getElementById(`nivel1-${lineId}`);
            // Usa o Nível 1 do cabeçalho como filtro inicial
            const nivel1HeaderValue = document.getElementById('nivel1_header').value;

            // Se o Nível 1 do cabeçalho foi selecionado, use-o como a única opção.
            if (nivel1HeaderValue) {
                populateSelect(nivel1Select, [nivel1HeaderValue], 'Nível 1');
                nivel1Select.value = nivel1HeaderValue; // Seta o valor
                nivel1Select.disabled = true; // Impede a alteração
                // Dispara o filtro para o Nível 2
                filterAndPopulateLine(1, lineId); 
            } else {
                // Se não, carrega a lista completa de Nível 1 (como antes, para o caso de esquecer de preencher o header)
                const nivel1Options = allOptionsData.map(row => row[0]);
                populateSelect(nivel1Select, nivel1Options, 'Nível 1');
                nivel1Select.disabled = false;
            }

            // 2. Adiciona os Event Listeners de CASCATA para esta nova linha (apenas N1 a N3)
            for (let i = 1; i <= 3; i++) { // Até o Nível 3, pois o Nível 4 é o último
                const currentSelect = document.getElementById(`nivel${i}-${lineId}`);
                currentSelect.addEventListener('change', () => filterAndPopulateLine(i, lineId));
            }
        }

        // Remove a linha do DOM
        function removeRateioLine(lineId) {
            const line = document.getElementById(lineId);
            if (line) {
                rateioContainer.removeChild(line);
            }
        }
        
        // FUNÇÃO DE FILTRO TOTALMENTE DEPENDENTE (AJUSTADA PARA 4 NÍVEIS)
        function filterAndPopulateLine(currentLevel, lineId) {
            const nextLevel = currentLevel + 1;
            
            // --- 1. Limpa e desativa todos os níveis seguintes (Nível 5 removido)---
            for (let i = nextLevel; i <= 4; i++) { // Vai até o Nível 4
                const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
                if(nextSelect) {
                    nextSelect.innerHTML = `<option value="" selected>Nível ${i}</option>`;
                    nextSelect.disabled = true;
                }
            }

            const nextSelect = document.getElementById(`nivel${nextLevel}-${lineId}`);
            if (!nextSelect) return; // Se for o Nível 4, não há próximo

            // --- 2. Coleta a Cadeia de Filtros ---
            const selectedChain = [];
            for (let i = 1; i <= currentLevel; i++) {
                const select = document.getElementById(`nivel${i}-${lineId}`);
                selectedChain.push(select ? select.value : ''); 
            }
            
            // --- 3. Aplica o Filtro Múltiplo ---
            let filteredOptions = allOptionsData;
            
            for (let i = 0; i < currentLevel; i++) {
                const filterValue = selectedChain[i];
                const filterIndex = i;

                if (filterValue) {
                    filteredOptions = filteredOptions.filter(row => row[filterIndex] === filterValue);
                }
            }
            
            // A opção do próximo nível está na coluna (nextLevel - 1) na matriz
            const nextOptions = filteredOptions.map(row => row[nextLevel - 1]);
            
            populateSelect(nextSelect, nextOptions, `Nível ${nextLevel}`);
            nextSelect.disabled = false;
        }


        // =======================================================================
        // LÓGICA DE FILTRO DO CENTRO (NOVO)
        // =======================================================================

        function filterCentro() {
            const nivel1HeaderSelect = document.getElementById('nivel1_header');
            const centroSelect = document.getElementById('centro');
            const nivel1Value = nivel1HeaderSelect.value;
            
            // Limpa o Centro e desativa
            centroSelect.innerHTML = '<option value="">Selecione a Área primeiro</option>';
            centroSelect.disabled = true;

            // Assumindo que a planilha 'Listas' ou 'Opções' retorna Centro com sua Área (Nível 1)
            if (nivel1Value && allFixedLists.CentroData) {
                const filteredCentros = allFixedLists.CentroData
                    .filter(item => item.area === nivel1Value) // Filtra pelo Nível 1 (Area)
                    .map(item => item.centro); // Pega apenas o nome do Centro
                
                populateSelect(centroSelect, filteredCentros, 'Selecione o Centro');
                centroSelect.disabled = false;
            }
            
            // NOVO: Também atualiza a primeira linha de rateio se já existir
            const firstRateioN1 = document.querySelector('#rateio-container select[name="nivel1"]');
            if (firstRateioN1) {
                firstRateioN1.value = nivel1Value;
                firstRateioN1.disabled = true; // Impede a alteração
                // Dispara a cascata para o Nível 2
                const lineId = firstRateioN1.dataset.lineId;
                if (nivel1Value) {
                    filterAndPopulateLine(1, lineId); 
                } else {
                    // Limpa os níveis seguintes se a Área for removida
                    for (let i = 2; i <= 4; i++) {
                        const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
                        if(nextSelect) {
                            nextSelect.innerHTML = `<option value="" selected>Nível ${i}</option>`;
                            nextSelect.disabled = true;
                        }
                    }
                }
            }
        }


        // =======================================================================
        // LÓGICA DE CARREGAMENTO INICIAL (AJUSTADA PARA O NOVO CAMPO CENTRO)
        // =======================================================================

        async function loadOptionsAndFixedLists() {
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_options`);
                const data = await response.json();

                if (data.result === 'success') {
                    allOptionsData = data.cascadingOptions; 
                    allFixedLists = data.fixedLists; // Armazena as listas fixas

                    // 1. Popula listas fixas no cabeçalho (Competência e Área Destino)
                    for (const header of ['Competência', 'Área Destino']) {
                        const options = allFixedLists[header] || [];
                        populateSelect(fixedSelects[header], options, `Selecione a ${header}`);
                        fixedSelects[header].disabled = false;
                    }

                    // 2. Popula o Nível 1/Área (Header) com base na primeira coluna da cascata
                    const nivel1HeaderSelect = document.getElementById('nivel1_header');
                    const nivel1Options = allOptionsData.map(row => row[0]);
                    populateSelect(nivel1HeaderSelect, nivel1Options, 'Selecione a Área');
                    nivel1HeaderSelect.disabled = false;

                    // 3. Adiciona listener de filtro para o Centro
                    nivel1HeaderSelect.addEventListener('change', filterCentro);

                    // 4. Cria a primeira linha de rateio
                    if (rateioContainer.children.length === 0) {
                        createRateioLine();
                    }
                    
                } else {
                    showMessage('error', `Erro ao carregar opções: ${data.error || 'Resposta inválida do servidor.'}`);
                }
            } catch (error) {
                console.error('Erro ao carregar opções:', error);
                showMessage('error', 'Falha na conexão com o Apps Script. Verifique a URL e o Deploy.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        // =======================================================================
        // FUNÇÃO 1: Coleta e estrutura os dados de rateio em um array JSON
        // =======================================================================
        function collectRateioData() {
            const rateioLines = document.querySelectorAll('#rateio-container .rateio-item');
            const rateioData = [];

            rateioLines.forEach(line => {
                const data = {};
                data.nivel1 = line.querySelector('select[name="nivel1"]').value || '';
                data.nivel2 = line.querySelector('select[name="nivel2"]').value || '';
                data.nivel3 = line.querySelector('select[name="nivel3"]').value || '';
                data.nivel4 = line.querySelector('select[name="nivel4"]').value || '';
                // 🛑 NÍVEL 5 REMOVIDO
                
                const valorInput = line.querySelector('input[name="valorRateio"]');
                
                // 🛑 CENTRO REMOVIDO DO JSON DE RATEIO
                data.valorRateio = valorInput ? parseFloat(valorInput.value) || 0 : 0;
                
                rateioData.push(data);
            });
            
            return JSON.stringify(rateioData);
        }
        
        // =======================================================================
        // FUNÇÃO 2: LÓGICA DE ENVIO DO FORMULÁRIO (doPost) - AJUSTADA
        // =======================================================================
        submissionForm.addEventListener("submit", async function(event) {
            event.preventDefault(); 
            const submitButton = submissionForm.querySelector('button.btn-submit');
            const centroValue = document.getElementById('centro').value;

            if (!centroValue) {
                showMessage('error', 'O campo **Centro de Custo/Receita** é obrigatório no cabeçalho.');
                return;
            }

            // ⚠️ Validação de Soma (Mantida)
            const valorTotalDoc = parseFloat(document.getElementById('valorTotal').value) || 0;
            const rateioInputs = document.querySelectorAll('input[name="valorRateio"]');
            let somaRateio = 0;
            rateioInputs.forEach(input => {
                somaRateio += parseFloat(input.value) || 0;
            });

            if (Math.abs(valorTotalDoc - somaRateio) > 0.01) {
                showMessage('error', `Erro de Rateio: O Valor Total do Documento (${valorTotalDoc.toFixed(2)}) não corresponde à soma dos rateios (${somaRateio.toFixed(2)}).`);
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando Pedido...';
            showMessage('loading', 'Processando sua solicitação (incluindo anexos, se houver)...');
            
            // Coleta todos os campos
            const formData = new FormData(submissionForm);
            
            // Adiciona o JSON do rateio
            formData.append('rateioJson', collectRateioData()); 
            
            // Adiciona o Centro como um parâmetro principal (lido no Apps Script)
            formData.append('centro', centroValue); 
            
            // Remove os campos de rateio individuais vazios para evitar poluir o Apps Script
            const rateioLineFields = ['nivel1', 'nivel2', 'nivel3', 'nivel4', 'nivel5', 'valorRateio'];
            rateioLineFields.forEach(name => formData.delete(name));
            formData.delete('numRateios'); 
            formData.delete('nivel1_header'); // Remove o Nível 1 do header (agora é apenas filtro)
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', 
                    body: formData
                });

                if (!response.ok) { throw new Error('Erro de rede ou servidor Apps Script.'); }
                const responseData = await response.json();

                if (responseData && responseData.result === "success") {
                    // Mensagem de sucesso atualizada
                    showMessage('success', `✅ Sucesso! Seu pedido foi registrado. ID do Documento: **#${responseData.id}**. Seus anexos foram salvos.`);
                    submissionForm.reset(); 
                    rateioContainer.innerHTML = ''; 
                    loadOptionsAndFixedLists(); 
                } else {
                    throw new Error(responseData.error || "Resposta inesperada do servidor Apps Script.");
                }

            } catch (error) {
                console.error('Erro:', error);
                showMessage('error', "Ops! Houve um erro no envio. Verifique a URL do Apps Script, o Deploy e o console do navegador.");
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Pedido de Reclassificação';
            }
        });

        // =======================================================================
        // LÓGICA DE BUSCA E RASTREAMENTO (Mantida)
        // =======================================================================
        const btnSearch = document.getElementById('btnSearch');
        const searchQueryInput = document.getElementById('searchQuery');
        const searchResultsDiv = document.getElementById('searchResults');

        btnSearch.addEventListener('click', handleSearch);
        searchQueryInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                handleSearch();
            }
        });

        async function handleSearch() {
            const query = searchQueryInput.value.trim();

            if (query.length < 3) {
                searchResultsDiv.innerHTML = '<p class="error message-box">Digite pelo menos **3 caracteres** (ID ou Nome) para buscar.</p>';
                return;
            }

            btnSearch.disabled = true;
            btnSearch.textContent = 'Buscando...';
            searchResultsDiv.innerHTML = '<p id="searchPlaceholder">Aguarde, pesquisando no sistema...</p>';

            try {
                // Chama a função search_requests no Apps Script
                const url = `${APPS_SCRIPT_URL}?action=search_requests&query=${encodeURIComponent(query)}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.result === 'success') {
                    renderSearchResults(data.data);
                } else {
                    searchResultsDiv.innerHTML = `<p class="error message-box">Erro: ${data.error || 'Falha ao buscar dados.'}</p>`;
                }

            } catch (error) {
                console.error('Erro na busca:', error);
                searchResultsDiv.innerHTML = '<p class="error message-box">Falha na conexão com o Apps Script ou erro de rede.</p>';
            } finally {
                btnSearch.disabled = false;
                btnSearch.textContent = 'Buscar Pedidos';
            }
        }
        
        // 🧠 FUNÇÃO: Mapeia o status para emoji e cor (Mantida)
        function getStatusInfo(status) {
            // Normaliza o status (remove acentos, espaços e transforma em lowercase)
            const s = status ? status.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]+/g, '_') : 'nao_encontrado';
            
            switch (s) {
                case 'pendente':
                    return { emoji: '⏳', class: 'status-pendente', label: 'Pendente' };
                case 'em_andamento':
                    return { emoji: '⚙️', class: 'status-em_andamento', label: 'Em Andamento' };
                case 'finalizado':
                    return { emoji: '✅', class: 'status-finalizado', label: 'Finalizado' };
                case 'duvida_enviada_no_email_do_solicitante':
                case 'duvida_enviada': // Adicionando uma variação mais curta para segurança
                    return { emoji: '📧', class: 'status-duvida_enviada', label: 'Dúvida Enviada' };
                default:
                    return { emoji: '❓', class: 'status-nao_encontrado', label: status || 'Status Indefinido' };
            }
        }

        // 🧠 FUNÇÃO: Renderiza resultados (Mantida)
        function renderSearchResults(results) {
            if (results.length === 0) {
                searchResultsDiv.innerHTML = '<p id="searchPlaceholder">Nenhum pedido encontrado com este critério.</p>';
                return;
            }

            let html = '<table class="results-table">';
            html += `
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Solicitante</th>
                        <th>Competência </th> <th>Valor Total</th>
                        <th>Status </th>
                        <th>Quem Está Fazendo </th> 
                        <th>Descrição / Justificativa </th> 
                    </tr>
                </thead>
                <tbody>
            `;

            results.forEach(item => {
                // Formatação de valor para Real Brasileiro
                const valorFormatado = (parseFloat(item.valorTotal) || 0).toFixed(2).replace('.', ',');
                const statusInfo = getStatusInfo(item.status); // Pega as informações de status e formatação

                html += `
                    <tr>
                        <td><strong>#${item.id}</strong></td>
                        <td>${item.solicitante}</td>
                        <td>${item.competencia}</td>
                        <td>R$ ${valorFormatado}</td>
                        <td>
                            <span class="status-tag ${statusInfo.class}">
                                ${statusInfo.emoji} ${statusInfo.label}
                            </span>
                        </td>
                        <td>${item.quemFaz || 'N/A'}</td>
                        <td>${item.descricao || 'N/A'}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            searchResultsDiv.innerHTML = html;
        }


        // =======================================================================
        // INICIALIZAÇÃO E EVENTOS
        // =======================================================================
        document.getElementById('add-rateio-line').addEventListener('click', () => {
            // O Nível 1 da linha de rateio é dependente do Nível 1 do cabeçalho
            if (!document.getElementById('nivel1_header').value) {
                showMessage('error', '⚠️ Por favor, selecione primeiro a **Área (Nível 1)** no cabeçalho do documento.');
                return;
            }
            createRateioLine();
        });
        document.addEventListener('DOMContentLoaded', loadOptionsAndFixedLists);

    </script>
</body>
</html>
