<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Pedido de Reclassifica√ß√£o (FP&A)</title>
    <style>
        :root {
            --primary-color: #005A9C; /* Azul Corporativo */
            --secondary-color: #F7F7F7;
            --text-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); }
        header { background-color: var(--primary-color); color: white; padding: 20px 0; text-align: center; margin-bottom: 25px; }
        .container { max-width: 1000px; margin: auto; padding: 25px; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h2 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px; }
        /* Ajuste do grid para a se√ß√£o de n√≠veis, que ter√° 3 colunas para caber mais */
        .grid-levels { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 25px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #555; }
        input[type="text"], input[type="number"], select, textarea { 
            width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s; font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        textarea { resize: vertical; min-height: 80px; }
        button { 
            background-color: var(--primary-color); color: white; padding: 12px 25px; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s;
        }
        button:disabled { background-color: #a4c4db; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #004580; }
        .message-box { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: 600; display: none; }
        .success { background-color: #d4edda; color: var(--success-color); border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: var(--error-color); border: 1px solid #f5c6cb; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2em; color: var(--primary-color); display: none; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Carregando Op√ß√µes...</div>
    <header>
        <h1>Pedido de Reclassifica√ß√£o de Centro/Conta (FP&A)</h1>
    </header>

    <div class="container">
        <form id="submission-form" enctype="multipart/form-data">
            <h2>1. Informa√ß√µes B√°sicas do Documento</h2>
            <div class="grid">
                <div>
                    <label for="parceiro">Nome do Parceiro:</label>
                    <input type="text" id="parceiro" name="parceiro" required>
                </div>
                <div>
                    <label for="solicitante">Solicitante:</label>
                    <input type="text" id="solicitante" name="solicitante" required>
                </div>
                <div>
                    <label for="docNumero">N¬∫ do Documento:</label>
                    <input type="text" id="docNumero" name="docNumero" required>
                </div>
                <div>
                    <label for="competencia">Compet√™ncia:</label>
                    <select id="competencia" name="competencia" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label for="valorTotal">Valor Total:</label>
                    <input type="number" step="0.01" id="valorTotal" name="valorTotal" required>
                </div>
                <div>
                    <label for="areaOrigem">√Årea Origem:</label>
                    <select id="areaOrigem" name="areaOrigem" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div>
                    <label for="centro">Centro de Custo/Receita:</label>
                    <input type="text" id="centro" name="centro" required>
                </div>
                <div>
                    <label for="areaDestino">√Årea Destino:</label>
                    <select id="areaDestino" name="areaDestino" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
            </div>

            <h2>2. Sele√ß√£o da Hierarquia Cont√°bil (Contas)</h2>
            <div class="grid-levels">
                <div>
                    <label for="nivel1">N√≠vel 1 (Conta Principal):</label>
                    <select id="nivel1" name="nivel1" required disabled>
                        <option value="">Carregando N√≠veis...</option>
                    </select>
                </div>
                <div>
                    <label for="nivel2">N√≠vel 2 (Subconta):</label>
                    <select id="nivel2" name="nivel2" required disabled>
                        <option value="">Selecione o N√≠vel 1</option>
                    </select>
                </div>
                <div>
                    <label for="nivel3">N√≠vel 3 (Detalhamento):</label>
                    <select id="nivel3" name="nivel3" required disabled>
                        <option value="">Selecione o N√≠vel 2</option>
                    </select>
                </div>
                <div>
                    <label for="nivel4">N√≠vel 4:</label>
                    <select id="nivel4" name="nivel4" required disabled>
                        <option value="">Selecione o N√≠vel 3</option>
                    </select>
                </div>
                <div>
                    <label for="nivel5">N√≠vel 5:</label>
                    <select id="nivel5" name="nivel5" required disabled>
                        <option value="">Selecione o N√≠vel 4</option>
                    </select>
                </div>
            </div>

            <h2>3. Detalhes e Justificativa</h2>
            <div>
                <label for="justificativa">Justificativa Detalhada da Reclassifica√ß√£o:</label>
                <textarea id="justificativa" name="justificativa" rows="4" required></textarea>
            </div>

            <button type="submit">Enviar Pedido de Reclassifica√ß√£o</button>
            <div id="form-message" class="message-box"></div>
        </form>
    </div>

    <script>
        // =======================================================================
        // üõë COLE O SEU URL DA WEB APP DO APPS SCRIPT AQUI
        // =======================================================================
        const APPS_SCRIPT_URL = 'COLE_O_SEU_URL_DO_APPS_SCRIPT_AQUI'; 
        
        // Vari√°veis de Controle
        const submissionForm = document.getElementById("submission-form");
        const formMessage = document.getElementById("form-message");
        const loadingOverlay = document.getElementById("loading-overlay");
        let allOptionsData = []; // Armazena a matriz completa da aba 'Opcoes'

        // Mapeamento dos Seletores de Cascata (N√çVEL 1 a N√çVEL 5)
        const cascadingSelects = {
            1: document.getElementById('nivel1'),
            2: document.getElementById('nivel2'),
            3: document.getElementById('nivel3'),
            4: document.getElementById('nivel4'),
            5: document.getElementById('nivel5')
        };

        // Mapeamento dos Seletores Fixos
        const fixedSelects = {
            'Compet√™ncia': document.getElementById('competencia'),
            '√Årea Origem': document.getElementById('areaOrigem'),
            '√Årea Destino': document.getElementById('areaDestino') 
        };

        // =======================================================================
        // FUN√á√ïES UTILIT√ÅRIAS
        // =======================================================================

        function showMessage(type, message) {
            formMessage.style.display = 'block';
            formMessage.className = `message-box ${type}`;
            formMessage.innerHTML = message;
        }

        function populateSelect(selectElement, options, initialText = 'Selecione') {
            selectElement.innerHTML = `<option value="" disabled selected>${initialText}</option>`;
            // Remove duplicatas e valores vazios
            const uniqueOptions = [...new Set(options.filter(Boolean))]; 
            
            uniqueOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.disabled = (uniqueOptions.length === 0);
        }

        // =======================================================================
        // L√ìGICA DE CARREGAMENTO E FILTRAGEM (A CHAVE DA CASCATA)
        // =======================================================================

        async function loadOptionsAndFixedLists() {
            loadingOverlay.style.display = 'flex';
            try {
                // Requisi√ß√£o GET para buscar listas do Apps Script
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_options`);
                const data = await response.json();

                if (data.result === 'success') {
                    // Os N√≠veis 1 a 5 est√£o nas colunas 0 a 4 da matriz (Ignorando o Centro que agora √© manual)
                    allOptionsData = data.cascadingOptions; 

                    // 1. Carrega as listas fixas
                    for (const header in fixedSelects) {
                        const options = data.fixedLists[header] || [];
                        populateSelect(fixedSelects[header], options, `Selecione a ${header}`);
                        fixedSelects[header].disabled = false;
                    }

                    // 2. Inicia o seletor de N√≠vel 1
                    const nivel1Options = allOptionsData.map(row => row[0]);
                    populateSelect(cascadingSelects[1], nivel1Options, 'Selecione o N√≠vel 1');
                    cascadingSelects[1].disabled = false;
                    
                } else {
                    showMessage('error', `Erro ao carregar op√ß√µes: ${data.error || 'Resposta inv√°lida do servidor.'}`);
                }
            } catch (error) {
                console.error('Erro ao carregar op√ß√µes:', error);
                showMessage('error', 'Falha na conex√£o com o Apps Script. Verifique a URL e o Deploy.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function filterAndPopulate(currentLevel) {
            const currentSelect = cascadingSelects[currentLevel];
            const nextLevel = currentLevel + 1;
            const nextSelect = cascadingSelects[nextLevel];
            const selectedValue = currentSelect.value;
            
            // Limpa e desativa todos os n√≠veis seguintes (N√≠veis 2 a 5)
            for (let i = nextLevel; i <= 5; i++) {
                cascadingSelects[i].innerHTML = `<option value="" disabled selected>Selecione o N√≠vel ${i - 1}</option>`;
                cascadingSelects[i].disabled = true;
            }

            if (!selectedValue) return;

            if (nextSelect) {
                // Filtra a matriz completa (allOptionsData)
                const nextOptions = allOptionsData
                    .filter(row => row[currentLevel - 1] === selectedValue) // Filtra pela coluna do n√≠vel anterior
                    .map(row => row[currentLevel]); // Pega o valor da coluna do n√≠vel atual
                
                populateSelect(nextSelect, nextOptions, `Selecione o N√≠vel ${currentLevel}`);
                nextSelect.disabled = false;
            }
        }

        // =======================================================================
        // EVENT LISTENERS (Ao mudar uma sele√ß√£o)
        // =======================================================================

        // Adiciona o listener de filtro para todos os n√≠veis de 1 a 4 (o N√≠vel 5 √© o √∫ltimo)
        for (let i = 1; i <= 4; i++) {
            cascadingSelects[i].addEventListener('change', () => filterAndPopulate(i));
        }

        // =======================================================================
        // L√ìGICA DE ENVIO DO FORMUL√ÅRIO (doPost)
        // =======================================================================

        submissionForm.addEventListener("submit", async function(event) {
            event.preventDefault(); 
            const submitButton = submissionForm.querySelector('button[type="submit"]');

            submitButton.disabled = true;
            submitButton.textContent = 'Enviando Pedido...';
            
            showMessage('loading', 'Processando sua solicita√ß√£o...');
            
            const data = new FormData(submissionForm);
            
            try {
                // Usamos o m√©todo POST para enviar os dados para o Apps Script
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', 
                    body: data 
                });

                if (!response.ok) {
                    throw new Error('Erro de rede ou servidor Apps Script.');
                }
                const responseData = await response.json();

                if (responseData && responseData.result === "success") {
                    showMessage('success', `Sucesso! Seu pedido foi registrado. ID do Documento: #${responseData.id}.`);
                    submissionForm.reset(); 
                    // Reinicia os seletores em cascata para o estado inicial
                    loadOptionsAndFixedLists(); 
                } else {
                    throw new Error("Resposta inesperada do servidor Apps Script. Verifique o console.");
                }

            } catch (error) {
                console.error('Erro:', error);
                showMessage('error', "Ops! Houve um erro no envio. Verifique a URL do Apps Script e o console do navegador.");

            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Enviar Pedido de Reclassifica√ß√£o';
            }
        });

        // =======================================================================
        // INICIALIZA√á√ÉO
        // =======================================================================
        document.addEventListener('DOMContentLoaded', loadOptionsAndFixedLists);
    </script>
</body>
</html>
