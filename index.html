<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedido de Reclassificação (Rateio)</title>
    <style>
        :root {
            --primary-color: #005A9C;
            --secondary-color: #F7F7F7;
            --text-color: #333;
            --success-color: #28a745;
            --error-color: #dc3545;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 0; background-color: var(--secondary-color); color: var(--text-color); }
        .container { max-width: 1200px; margin: auto; padding: 30px; background: white; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: var(--primary-color); }
        h1 { text-align: center; font-size: 2em; margin-bottom: 20px; }
        h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 25px; font-size: 1.5em; }
        .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.95em; color: #555; }
        input[type="text"], input[type="number"], input[type="email"], select, textarea, input[type="file"] { 
            width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; 
            transition: border-color 0.3s; font-size: 1em;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); outline: none; }
        textarea { resize: vertical; min-height: 100px; }
        .rateio-header { display: flex; font-weight: 600; margin-bottom: 10px; padding: 0 10px; color: var(--primary-color); font-size: 0.9em; align-items: center; }
        .rateio-header div { flex: 1 1 0; margin-right: 10px; }
        .rateio-header .header-center, .rateio-header .header-valor { flex: 0 0 120px; }
        .rateio-header .header-remover { flex: 0 0 40px; }
        .rateio-item { display: flex; gap: 10px; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; border-radius: 4px; align-items: center; }
        .rateio-item .select-container, .rateio-item .input-center, .rateio-item .input-valor { flex: 1 1 0; }
        .rateio-item .input-center, .rateio-item .input-valor { min-width: 120px; }
        .btn-add-line, .btn-submit { color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; font-weight: bold; transition: background-color 0.3s; padding: 12px 25px; }
        .btn-add-line { background-color: #5cb85c; margin-top: 15px; }
        .btn-add-line:hover { background-color: #4cae4c; }
        .btn-submit { background-color: var(--primary-color); width: 100%; margin-top: 25px; }
        .btn-submit:disabled { background-color: #a4c4db; cursor: not-allowed; }
        .btn-submit:hover:not(:disabled) { background-color: #004580; }
        .btn-remove-line { background-color: #dc3545; color: white; padding: 8px 10px; border: none; border-radius: 4px; cursor: pointer; flex: 0 0 40px; }
        .btn-remove-line:hover { background-color: #c9303d; }
        .message-box { margin-top: 20px; padding: 15px; border-radius: 4px; font-weight: 600; display: none; text-align: center; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; font-size: 1.2em; color: var(--primary-color); display: none; }
    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">Carregando...</div>
    
    <?!= createNavBar('form'); ?> 

    <div class="container">
        <h1>Formulário de Reclassificação de Centro/Conta</h1>
        <form id="submission-form" enctype="multipart/form-data">
            <h2>1. Dados do Solicitante e Documento</h2>
            <div class="section-grid">
                <div class="input-group">
                    <label for="solicitante">Solicitante:</label>
                    <input type="text" id="solicitante" name="solicitante" required>
                </div>
                <div class="input-group">
                    <label for="emailSolicitante">E-mail do Solicitante:</label>
                    <input type="email" id="emailSolicitante" name="emailSolicitante" required>
                </div>
                <div class="input-group">
                    <label for="parceiro">Nome do Parceiro:</label>
                    <input type="text" id="parceiro" name="parceiro" required>
                </div>
                <div class="input-group">
                    <label for="docNumero">Nº do Documento/Histórico:</label>
                    <input type="text" id="docNumero" name="docNumero" required>
                </div>
                <div class="input-group">
                    <label for="valorTotal">Valor Total do Documento (R$):</label>
                    <input type="number" step="0.01" id="valorTotal" name="valorTotal" required>
                </div>
                <div class="input-group">
                    <label for="competencia">Competência:</label>
                    <select id="competencia" name="competencia" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="areaDestino">Área Destino:</label>
                    <select id="areaDestino" name="areaDestino" required disabled>
                        <option value="">Carregando...</option>
                    </select>
                </div>
            </div>

            <h2>2. Detalhamento e Rateio da Conta</h2>
            <div class="rateio-header">
                <div>Nível 1</div> <div>Nível 2</div> <div>Nível 3</div> <div>Nível 4</div> <div>Nível 5</div>
                <div class="header-center">Centro</div> <div class="header-valor">Valor (R$)</div> <div class="header-remover"></div>
            </div>
            <div id="rateio-container"></div>
            <button type="button" class="btn-add-line" id="add-rateio-line">+ Adicionar Linha de Rateio</button>

            <h2>3. Descrição e Anexos</h2>
            <div class="input-group">
                <label for="justificativa">Descrição Detalhada:</label>
                <textarea id="justificativa" name="justificativa" rows="4" required></textarea>
            </div>
            <div class="input-group">
                <label for="fileUpload">Anexar Documentos/Fotos (Opcional):</label>
                <input type="file" id="fileUpload" name="fileUpload" multiple>
            </div>
            
            <button type="submit" class="btn-submit">Enviar Pedido de Reclassificação</button>
            <div id="form-message" class="message-box"></div>
        </form>
    </div>

    <script>
        const APPS_SCRIPT_URL = '<?= ScriptApp.getService().getUrl() ?>';
        const submissionForm = document.getElementById("submission-form");
        const formMessage = document.getElementById("form-message");
        const loadingOverlay = document.getElementById("loading-overlay");
        const rateioContainer = document.getElementById('rateio-container');
        let allOptionsData = [];

        const fixedSelects = {
            'Competência': document.getElementById('competencia'),
            'Área Destino': document.getElementById('areaDestino') 
        };

        function showMessage(type, message) {
            formMessage.style.display = 'block';
            formMessage.className = `message-box ${type}`;
            formMessage.innerHTML = message;
        }

        function populateSelect(selectElement, options, initialText = 'Selecione') {
            selectElement.innerHTML = `<option value="">${initialText}</option>`;
            const uniqueOptions = [...new Set(options.filter(Boolean))];
            uniqueOptions.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
            selectElement.disabled = (uniqueOptions.length === 0);
        }

        function createRateioLine() {
            const lineId = Date.now();
            const div = document.createElement('div');
            div.className = 'rateio-item';
            div.id = `line-${lineId}`;
            
            let html = '';
            for (let i = 1; i <= 5; i++) {
                html += `<div class="select-container"><select name="nivel${i}" id="nivel${i}-${lineId}" disabled data-level="${i}"><option value="">Nível ${i}</option></select></div>`;
            }

            html += `
                <div class="input-center"><input type="text" name="centro" placeholder="Centro" required></div>
                <div class="input-valor"><input type="number" step="0.01" name="valorRateio" placeholder="Valor" required></div>
                <button type="button" class="btn-remove-line" data-line-id="${lineId}">X</button>
            `;

            div.innerHTML = html;
            rateioContainer.appendChild(div);

            const nivel1Select = document.getElementById(`nivel1-${lineId}`);
            const nivel1Options = allOptionsData.map(row => row[0]);
            populateSelect(nivel1Select, nivel1Options, 'Nível 1');
            nivel1Select.disabled = false;

            for (let i = 1; i <= 4; i++) {
                document.getElementById(`nivel${i}-${lineId}`).addEventListener('change', () => filterAndPopulateLine(i, lineId));
            }
            div.querySelector('.btn-remove-line').addEventListener('click', () => removeRateioLine(lineId));
        }

        function removeRateioLine(lineId) {
            const line = document.getElementById(`line-${lineId}`);
            if (line) line.remove();
        }
        
        function filterAndPopulateLine(currentLevel, lineId) {
            const nextLevel = currentLevel + 1;
            for (let i = nextLevel; i <= 5; i++) {
                const nextSelect = document.getElementById(`nivel${i}-${lineId}`);
                nextSelect.innerHTML = `<option value="">Nível ${i}</option>`;
                nextSelect.disabled = true;
            }

            const selectedChain = [];
            for (let i = 1; i <= currentLevel; i++) {
                const select = document.getElementById(`nivel${i}-${lineId}`);
                if (!select.value) {
                    return; // Interrompe se um nível intermediário for desmarcado
                }
                selectedChain.push(select.value);
            }
            
            const nextSelect = document.getElementById(`nivel${nextLevel}-${lineId}`);
            if (!nextSelect) return;

            let filteredOptions = allOptionsData.filter(row => {
                return selectedChain.every((selectedValue, index) => row[index] === selectedValue);
            });
            
            const nextOptions = filteredOptions.map(row => row[nextLevel - 1]);
            populateSelect(nextSelect, nextOptions, `Nível ${nextLevel}`);
        }

        async function loadOptionsAndFixedLists() {
            loadingOverlay.style.display = 'flex';
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_options`);
                const data = await response.json();
                if (data.result === 'success') {
                    allOptionsData = data.cascadingOptions;
                    for (const header in fixedSelects) {
                        populateSelect(fixedSelects[header], data.fixedLists[header] || [], `Selecione a ${header}`);
                    }
                    if (rateioContainer.children.length === 0) createRateioLine();
                } else {
                    showMessage('error', `Erro ao carregar opções: ${data.error || 'Resposta inválida.'}`);
                }
            } catch (error) {
                console.error('Erro:', error);
                showMessage('error', 'Falha na conexão. Verifique a URL e o Deploy.');
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        function collectRateioData() {
            const rateioData = [];
            document.querySelectorAll('#rateio-container .rateio-item').forEach(line => {
                rateioData.push({
                    nivel1: line.querySelector('select[name="nivel1"]').value || '',
                    nivel2: line.querySelector('select[name="nivel2"]').value || '',
                    nivel3: line.querySelector('select[name="nivel3"]').value || '',
                    nivel4: line.querySelector('select[name="nivel4"]').value || '',
                    nivel5: line.querySelector('select[name="nivel5"]').value || '',
                    centro: line.querySelector('input[name="centro"]').value.trim() || '',
                    valorRateio: parseFloat(line.querySelector('input[name="valorRateio"]').value) || 0
                });
            });
            return JSON.stringify(rateioData);
        }

        submissionForm.addEventListener("submit", async function(event) {
            event.preventDefault();
            const submitButton = this.querySelector('button.btn-submit');
            
            const valorTotalDoc = parseFloat(document.getElementById('valorTotal').value) || 0;
            let somaRateio = 0;
            document.querySelectorAll('input[name="valorRateio"]').forEach(input => somaRateio += parseFloat(input.value) || 0);

            if (Math.abs(valorTotalDoc - somaRateio) > 0.01) {
                showMessage('error', `A soma dos rateios (R$ ${somaRateio.toFixed(2)}) não corresponde ao Valor Total (R$ ${valorTotalDoc.toFixed(2)}).`);
                return;
            }

            submitButton.disabled = true;
            loadingOverlay.style.display = 'flex';
            
            const formData = new FormData(this);
            formData.append('rateioJson', collectRateioData());
            ['nivel1','nivel2','nivel3','nivel4','nivel5','centro','valorRateio'].forEach(name => formData.delete(name));
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await response.json();
                if (data.result === "success") {
                    showMessage('success', `✅ Sucesso! Pedido **#${data.id}** registrado.`);
                    this.reset();
                    rateioContainer.innerHTML = '';
                    createRateioLine();
                } else {
                    throw new Error(data.error || "Erro inesperado do servidor.");
                }
            } catch (error) {
                console.error('Erro no envio:', error);
                showMessage('error', `Ops! Houve um erro no envio: ${error.message}`);
            } finally {
                submitButton.disabled = false;
                loadingOverlay.style.display = 'none';
            }
        });

        document.getElementById('add-rateio-line').addEventListener('click', createRateioLine);
        document.addEventListener('DOMContentLoaded', loadOptionsAndFixedLists);
    </script>
</body>
</html>
