<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Status</title>
  <style>
    /* Cole o c√≥digo CSS do seu Pesquisa.html original aqui. 
       Eu estou assumindo que voc√™ manter√° os estilos originais para:
       .status-badge, .status-Pendente, etc. */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
    h1 { color: #005A9C; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 20px; }
    /* Estilos do formul√°rio e bot√£o de busca */
    #searchForm { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; }
    #searchTerm { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
    #searchButton { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
    #searchButton:hover { background-color: #0056b3; }
    #loadingMessage { text-align: center; padding: 15px; color: #005A9C; font-weight: bold; display: none; }
    /* Estilos da tabela e badges de status */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background-color: #f2f2f2; color: #333; }
    tr:nth-child(even) { background-color: #f9f9f9; }
    .status-badge { padding: 5px 10px; border-radius: 12px; font-weight: bold; color: white; display: inline-block; font-size: 0.9em; min-width: 70px; text-align: center; }
    .status-Pendente { background-color: #ffc107; color: #333; }
    .status-Aprovado { background-color: #28a745; }
    .status-Reprovado { background-color: #dc3545; }
    .status-Finalizado { background-color: #007bff; }
    .status-N/A { background-color: #6c757d; }
    /* Estilo da NavBar adaptado para o GitHub Pages */
    nav { background-color: #005A9C; padding: 10px 30px; margin-bottom: 20px; }
    nav div { max-width: 1200px; margin: auto; display: flex; gap: 30px; }
    nav a { color: white; text-decoration: none; font-weight: bold; padding: 5px 0; }
    .active-search { border-bottom: 2px solid white; }
  </style>
</head>
<body>
  <nav>
      <div>
          <a href="index.html">üìù Pedido de Rateio</a>
          <a href="pesquisa.html" class="active-search">üîé Consultar Status</a>
      </div>
  </nav>

  <div class="container">
    <h1>üîé Consultar Status de Rateios</h1>

    <form id="searchForm">
      <input type="text" id="searchTerm" placeholder="Buscar por ID do Documento (5 d√≠gitos) ou Nome do Solicitante" required>
      <button type="submit" id="searchButton">Buscar</button>
    </form>

    <div id="loadingMessage">Buscando... Por favor, aguarde.</div>
    <div id="resultsContainer">
      <p id="initialMessage">Digite o ID do documento ou o nome do solicitante para ver o status.</p>
    </div>
  </div>

  <script>
    // *** IMPORTANTE: SUBSTITUA PELA SUA URL DE IMPLANTA√á√ÉO APPS SCRIPT ATUAL ***
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8H2P6Mur5XroK3kvtuXVppW4-utOEZ4eXm080vLonQwrPey2YhAXBK_50hZl1gqLL/exec';

    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('searchForm');
      const searchTermInput = document.getElementById('searchTerm');
      const resultsContainer = document.getElementById('resultsContainer');
      const loadingMessage = document.getElementById('loadingMessage');
      const initialMessage = document.getElementById('initialMessage');
      const searchButton = document.getElementById('searchButton');

      form.addEventListener('submit', handleSearch);

      function handleSearch(e) {
        e.preventDefault();
        const term = searchTermInput.value.trim();
        if (term.length < 2) {
          alert('Por favor, insira pelo menos 2 caracteres para a busca.');
          return;
        }

        // 1. Mostrar estado de carregamento
        initialMessage.style.display = 'none';
        resultsContainer.innerHTML = '';
        loadingMessage.style.display = 'block';
        searchButton.disabled = true;
        searchButton.textContent = 'Buscando...';

        // 2. Chamar a fun√ß√£o do Apps Script via FETCH/API
        // Usamos a 'action=search_requests' para rotear no doGet do Apps Script
        const url = `${APPS_SCRIPT_URL}?action=search_requests&term=${encodeURIComponent(term)}`;

        fetch(url)
          .then(response => {
            if (!response.ok) {
                throw new Error('Erro de rede ao buscar dados.');
            }
            return response.json();
          })
          .then(displayResults)
          .catch(handleError);
      }

      function displayResults(response) {
        // 3. Ocultar estado de carregamento
        loadingMessage.style.display = 'none';
        searchButton.disabled = false;
        searchButton.textContent = 'Buscar';
        
        // Tratar a resposta
        if (response.result === 'success') {
          const requests = response.requests;
          
          if (requests.length === 0) {
            resultsContainer.innerHTML = '<p style="color: #dc3545; font-weight: bold;">Nenhum registro encontrado para o termo inserido.</p>';
            return;
          }

          // Construir a tabela de resultados
          let tableHTML = '<table>';
          tableHTML += '<thead><tr><th>ID</th><th>Data Envio</th><th>Solicitante</th><th>Valor Total</th><th>Status</th></tr></thead><tbody>';

          requests.forEach(req => {
            const statusClass = 'status-' + req.Status.replace(/[^a-zA-Z0-9]/g, ''); 
            
            const valorFormatado = new Intl.NumberFormat('pt-BR', {
              style: 'currency',
              currency: 'BRL'
            }).format(req.ValorTotal);
            
            tableHTML += `
              <tr>
                <td>${req.ID}</td>
                <td>${req.Data}</td>
                <td>${req.Solicitante}</td>
                <td>${valorFormatado}</td>
                <td><span class="status-badge ${statusClass}">${req.Status}</span></td>
              </tr>
            `;
          });

          tableHTML += '</tbody></table>';
          resultsContainer.innerHTML = tableHTML;

        } else {
          resultsContainer.innerHTML = `<p style="color: red;">Erro ao carregar dados: ${response.error || 'Erro desconhecido.'}</p>`;
          console.error("Erro do servidor:", response.error);
        }
      }

      function handleError(error) {
        // 4. Ocultar estado de carregamento e mostrar erro
        loadingMessage.style.display = 'none';
        searchButton.disabled = false;
        searchButton.textContent = 'Buscar';
        resultsContainer.innerHTML = `<p style="color: red;">Ocorreu um erro de comunica√ß√£o: ${error.message}</p>`;
        console.error("Erro de comunica√ß√£o com o Apps Script:", error);
      }
    });
  </script>
</body>
</html>
